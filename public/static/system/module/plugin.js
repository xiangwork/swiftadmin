layui.define(["i18n"],(function(a){var l=layui.jquery,e=layui.table,i=layui.i18n,t=layui.form;i.render(layui.admin.getStorage("language")||"zh-CN");var n=[l(window).width()>800?"660px":"85%",l(window).height()>800?"680px":"85%"],s={apiUrl:_global_.api,baseUrl:_global_.app,install:function(a,e,t){l.post(s.baseUrl+t,{name:a,token:e},(function(e){if(layer.closeAll(),200==e.code){layer.msg(e.msg);var n=layui.sessionData("api_install_index").index,r=l('tr[data-index="'+n+'"]');if(-1!=t.indexOf("install")){var u="",o='<input type="checkbox" lay-filter="switchStatus" data-url="';o+=s.baseUrl+'/system.plugin/status" value="'+a+'" lay-skin="switch" checked="">',o+='<div class="layui-unselect layui-form-switch layui-form-onswitch" lay-skin="_switch"><em></em><i></i></div>',l(r).find('[data-field="status"]').children("div").append(o),data=e.data||[],data.config&&(u+='<a class="layui-table-text" lay-title="'+i.prop("配置插件")+'"',u+='data-area="'+data.area+'" lay-maxmin="true"',u+='data-url="'+s.baseUrl+"/system.plugin/config/name/"+a+'" ',u+='lay-event="edit">'+i.prop("配置")+"</a>",u+='<div class="layui-divider layui-divider-vertical"></div> '),u+='<a class="layui-table-text uninstall" style="color:red"',u+='data-url="'+s.baseUrl+"/system.plugin/uninstall/name/"+a+'">'+i.prop("卸载")+"</a> ",l(r).find("td:last").children("div").html(u),window.plugins[a]=e.data}else r.find(".layui-upgrade-elem").remove(),r.find(".layui-form-switch").addClass("bubble"),r.find(".layui-form-switch").trigger("click",["stopPropagation"]);top.layui.admin.reloadLayout()}else{if(layer.msg(e.msg,"error"),-101===e.code)return s.login(),!1;if(-102===e.code)return s.pay(e.data),!1}}),"json")},login:function(){layer.open({type:1,title:"登录",shadeClose:!0,area:["500px","350px"],content:s.getHtml(),success:function(a,e){t.on("submit(login)",(function(a){return l.post(s.apiUrl+"/user/login",a.field,(function(a){200===a.code?(layui.admin.setStorage("api_cross_token",a.data.token),layer.closeAll(),s.againclick()):layer.msg(a.msg,"error")}),"json"),!1}))}})},clearLogin:function(){layui.admin.setStorage("api_cross_token",null)},pay:function(a){layer.open({type:2,title:i.prop("立即支付"),area:n,offset:"30px",resize:!1,shade:.8,shadeClose:!0,content:a.payUrl,success:function(a,l){window.onmessage=function(a){var e=a.data;null!==a.data&&200==e.code&&(layer.close(l),s.againclick()),null!==a.data&&-133==e.code&&layer.close(l)}}})},againclick:function(){try{var a=layui.sessionData("api_install_index").index,e=l('tr[data-index="'+a+'"]').children().find(".install");e.length<=0&&(e=l('[layui-value="'+a+'"]')),e&&null!=a&&l(e).trigger("click")}catch(a){}},uninstall:function(a,t){var n=s.baseUrl;l.post(n+s.getUrl("plugin","uninstall"),{name:a,tables:t},(function(t){if(200===t.code){layer.msg(t.msg);var s=layui.sessionData("api_install_index").index,r=l('tr[data-index="'+s+'"]');l(r).find('[data-field="status"]').children("div").html("");var u='<a class="layui-table-text install" data-url="'+n;u+="/system.plugin/install/name/"+a+'">'+i.prop("安装")+"</a>";var o=e.cache["lay-tableList"][s];void 0!==o.demourl&&(u+='<div class="layui-divider layui-divider-vertical"></div>',u+='<a class="layui-table-text" target="_blank" href="',u+=o.demourl+'">'+i.prop("演示")+"</a>"),delete window.plugins[a],l(r).find("td:last").children("div").html(u)}else layer.msg(i.prop(t.msg),"error");layer.close(window.unIndex)}),"json")},getUrl:(a,l)=>"/system."+a+"/"+l,getTableData:function(a){if(null==a||"undefined"==a)return!1;var i=l(a).parents("tr").attr("data-index");return i=e.cache["lay-tableList"][i]},getHtml:function(){return'<blockquote class="layui-elem-quote layui-elem-plugin">','</blockquote><div style="height:20px;"></div>','<div class="layui-form-item">','<label class="layui-form-label">用户帐号</label>','<div class="layui-input-block">','<input type="text" name="nickname" style="width:330px;" lay-verify="required" placeholder="请输入邮箱或手机号" class="layui-input" >',"</div></div>",'<div class="layui-form-item"><label class="layui-form-label">密码</label>','<div class="layui-input-block">','<input type="password" name="pwd" style="width:330px;" lay-verify="required" placeholder="请输入密码" class="layui-input">',"</div></div>",'<div class="layui-form-item" style="margin-top: 22px;text-align: center;">','<a class="layui-btn layui-btn-primary" href="http://www.swiftadmin.net/user/register" target="_blank">注册</a>','<button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="login">登录</button>',"</div></form> ",'<form class="layui-form layui-form-fixed" style="padding-right:15px;" ><blockquote class="layui-elem-quote layui-elem-plugin"></blockquote><div style="height:20px;"></div><div class="layui-form-item"><label class="layui-form-label">用户帐号</label><div class="layui-input-block"><input type="text" name="nickname" style="width:330px;" lay-verify="required" placeholder="请输入邮箱或手机号" class="layui-input" ></div></div><div class="layui-form-item"><label class="layui-form-label">密码</label><div class="layui-input-block"><input type="password" name="pwd" style="width:330px;" lay-verify="required" placeholder="请输入密码" class="layui-input"></div></div><div class="layui-form-item" style="margin-top: 22px;text-align: center;"><a class="layui-btn layui-btn-primary" href="http://www.swiftadmin.net/user/register" target="_blank">注册</a><button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="login">登录</button></div></form> '}};l(".layui-plugin-select").click((function(){var a=l(this);a.hasClass("active")&&!a.hasClass("first")?(a.removeClass("active"),a.siblings("span.first").addClass("active")):(a.siblings(".active").removeClass("active"),a.addClass("active"));var i={};l(".active").each((function(a,e){var t=l(e).attr("data-value")||"",n=l(e).parent().attr("name");i[n]=t}));var t=["type","pay","label"];for(let a in t)i[t[a]]||(i[t[a]]="");e.reload("lay-tableList",{where:i,url:s.apiUrl+"plugin/index"})})),l(document).on("click",".install,.upgrade",(function(){var a=l(this),e=layer.load(),t=a.attr("class"),n=a.attr("lay-type")||"plugin",r=t.replace("layui-table-text","").replace(/(^\s*)|(\s*$)/g,""),u=s.getTableData(this).name,o=layui.admin.getStorage("api_cross_token")||null;if(layui.sessionData("api_install_index",{key:"index",value:s.getTableData(this).LAY_TABLE_INDEX}),null==o||"undefined"==o)return layer.close(e),s.login(),!1;if(-1!=r.indexOf("upgrade")){var c='<div class="lay-upgrade">确认升级《<font size="4">'+u+"</font>》插件？<br/>";c+='<font color="red">1、请务必做好代码和数据库备份！</font><br/>',c+='<font color="red">2、升级后如出现冗余数据，请根据需要移除即可！</font><br/>',c+='<font color="red">3、生产环境下更新插件，请勿在流量高峰期操作！</font><br/></div>';var d=layer.confirm(c,{title:i.prop("更新提示")},(function(){layer.close(d),s.install(u,o,s.getUrl(n,r))}),(function(){layer.close(e)}))}else s.install(u,o,s.getUrl(n,r))})),t.on("switch(pluginStatus)",(function(a){var e=l(this),i={error:function(e){l(a.elem).prop("checked",!a.elem.checked),t.render("checkbox"),layer.msg(e.msg,"error")},success:function(a){layer.msg(a.msg),window.plugins[n.id].status=n.status,top.layui.admin.reloadLayout()}},n={id:l(this).attr("value"),status:a.elem.checked?1:0};if(l(".bubble").length)return l(".bubble").removeClass("bubble"),!1;layui.admin.event.request(e,n,i)})),l(document).on("click",".uninstall",(function(a){var e=s.getTableData(this).name,n='<form class="layui-form layui-form-fixed" style="padding-right:15px;background: #f2f2f2;" >';n+='<blockquote class="layui-elem-quote layui-elem-uninstall">温馨提示<br/>',n+="确认卸载 《"+e+"》 吗？<br/>",n+="1、卸载前请自行备份插件数据库 ！<br/>",n+="2、插件文件及数据库表删除后无法找回 ！<br/>",n+="3、插件如已被二次开发，请自行清除冗余文件！<br/>",n+="</blockquote>",n+='<div class="layui-form-item">',n+='<div class="layui-input-inline" style="padding-left: 5px;">',n+='<input type="checkbox" lay-filter="tables" lay-skin="primary" title="删除插件相关数据库表" >',n+='<div class="layui-plugin-tables layui-badge-red"></div></div></div>',n+='<div class="layui-footer" style="margin-top: 22px;text-align: center;">',n+='<button type="submit" class="layui-btn layui-btn-normal" lay-submit lay-filter="start">确定</button>',n+='<button type="button" class="layui-btn layui-btn-primary" sa-event="closeDialog" >关闭</button>',n+="</div></form> ",layui.sessionData("api_install_index",{key:"index",value:s.getTableData(this).LAY_TABLE_INDEX}),layer.open({type:1,title:i.prop("卸载插件"),shadeClose:!0,area:["380px","360px"],content:n,success:function(a,i){t.render(),t.on("checkbox(tables)",(function(a){a.elem.checked?l.get(s.baseUrl+"/system.plugin/tables",{name:e},(function(a){try{if(200==a.code&&a.data.tables){var e=[];for(var i in l(".layui-plugin-tables").append("<span>即将删除数据表：</span>").show(),a.data.tables){e.push([a.data.tables[i]]);var t="<span>"+a.data.tables[i]+"</span>、";l(".layui-plugin-tables").append(t)}}else layer.msg(a.msg,"error")}catch(a){}}),"json"):l(".layui-plugin-tables").html("").hide()})),t.on("submit(start)",(function(a){var t=[];return l(".layui-plugin-tables").children("span").each((function(a,e){a>=1&&t.push(l(e).html())})),window.unIndex=layer.load(),layer.close(i),s.uninstall(e,t),!1}))}})})),l("*[data-value=install]").click((function(a){e.reload("lay-tableList",{url:s.baseUrl+"/system.plugin/index?type=install"})})),l("*[data-value=cache]").click((function(a){var e=layer.confirm("确定要更新缓存吗？",{title:"更新提示"},(function(){l.get(s.baseUrl+s.getUrl("admin","clear/type/plugin"),{},(function(a){200===a.code?(layer.msg(a.msg),layer.close(e)):layer.msg(a.msg,"error")}))}))})),l("body").on("click",".layui-icon-picture",(function(a){let l=s.getTableData(this),e=[];if(void 0!==l.album&&l.album.length)for(let a in l.album)e.push({src:l.album[a].src,thumb:l.album[a].src});layer.photos({photos:{data:e},shadeClose:!0,closeBtn:2,anim:10})})),a("plugin",s)}));